{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Home \u00b6 Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"#home","text":"Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"feedback/","text":"Feedback Welcomed \u00b6 Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"feedback/#feedback-welcomed","text":"Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"getting-started/configure-keepalived/","text":"Configure Keepalived \u00b6 Determine your IP address \u00b6 Run the following command to find your IP address and interface in use on both primary and secondary servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12/24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Primary eth0 10.0.100.11 Secondary ens192 10.0.100.12 VIP * - 10.0.100.10/24 *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10/24 (as shown in the above table). Configuration \u00b6 Use the editor of your choice to open the keepalived configuration on both Primary and Secondary servers. sudo nano /etc/keepalived/keepalived.conf Primary Server (Master) \u00b6 Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. unicast_src_ip 10.0.100.11 Your Primary server's IP. unicast_peer 10.0.100.12 Your Secondary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state MASTER interface eth0 virtual_router_id 55 priority 150 advert_int 1 unicast_src_ip 10 .0.100.11 unicast_peer { 10 .0.100.12 } authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 } track_process { ftl } } auth_pass must match on both Primary and Secondary servers. Secondary Server (Backup) \u00b6 Change the values according to the following table. Field Current Value Change to interface ens192 Your Secondary server's Interface. unicast_src_ip 10.0.100.12 Your Secondary server's IP. unicast_peer 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Secondary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 55 priority 145 advert_int 1 unicast_src_ip 10 .0.100.12 unicast_peer { 10 .0.100.11 } authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 } track_process { ftl } } auth_pass must match on both Primary and Secondary servers. Restart Keepalived \u00b6 Ubuntu \u00b6 (using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived Debian \u00b6 sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Configure"},{"location":"getting-started/configure-keepalived/#configure-keepalived","text":"","title":"Configure Keepalived"},{"location":"getting-started/configure-keepalived/#determine-your-ip-address","text":"Run the following command to find your IP address and interface in use on both primary and secondary servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12/24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Primary eth0 10.0.100.11 Secondary ens192 10.0.100.12 VIP * - 10.0.100.10/24 *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10/24 (as shown in the above table).","title":"Determine your IP address"},{"location":"getting-started/configure-keepalived/#configuration","text":"Use the editor of your choice to open the keepalived configuration on both Primary and Secondary servers. sudo nano /etc/keepalived/keepalived.conf","title":"Configuration"},{"location":"getting-started/configure-keepalived/#primary-server-master","text":"Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. unicast_src_ip 10.0.100.11 Your Primary server's IP. unicast_peer 10.0.100.12 Your Secondary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state MASTER interface eth0 virtual_router_id 55 priority 150 advert_int 1 unicast_src_ip 10 .0.100.11 unicast_peer { 10 .0.100.12 } authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 } track_process { ftl } } auth_pass must match on both Primary and Secondary servers.","title":"Primary Server (Master)"},{"location":"getting-started/configure-keepalived/#secondary-server-backup","text":"Change the values according to the following table. Field Current Value Change to interface ens192 Your Secondary server's Interface. unicast_src_ip 10.0.100.12 Your Secondary server's IP. unicast_peer 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Secondary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 55 priority 145 advert_int 1 unicast_src_ip 10 .0.100.12 unicast_peer { 10 .0.100.11 } authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 } track_process { ftl } } auth_pass must match on both Primary and Secondary servers.","title":"Secondary Server (Backup)"},{"location":"getting-started/configure-keepalived/#restart-keepalived","text":"","title":"Restart Keepalived"},{"location":"getting-started/configure-keepalived/#ubuntu","text":"(using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived","title":"Ubuntu"},{"location":"getting-started/configure-keepalived/#debian","text":"sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Debian"},{"location":"getting-started/install-keepalived/","text":"Install Keepalived \u00b6 Ubuntu \u00b6 Use snap to install the latest version of keepalived and then apt to install libipset13. sudo snap install keepalived --classic sudo apt install libipset13 * see https://snapcraft.io/install/keepalived/ubuntu for more information Debian \u00b6 sudo apt install keepalived lilbipset13","title":"Install"},{"location":"getting-started/install-keepalived/#install-keepalived","text":"","title":"Install Keepalived"},{"location":"getting-started/install-keepalived/#ubuntu","text":"Use snap to install the latest version of keepalived and then apt to install libipset13. sudo snap install keepalived --classic sudo apt install libipset13 * see https://snapcraft.io/install/keepalived/ubuntu for more information","title":"Ubuntu"},{"location":"getting-started/install-keepalived/#debian","text":"sudo apt install keepalived lilbipset13","title":"Debian"},{"location":"getting-started/tested-configuration/","text":"Tested Configuration \u00b6 Server Platform OS Keepalived Version Primary raspberry pi Ubuntu 20.04 2.2.7 Secondary Failover Virtualized Debian 11 2.1.5 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfuly.","title":"Tested Configuration"},{"location":"getting-started/tested-configuration/#tested-configuration","text":"Server Platform OS Keepalived Version Primary raspberry pi Ubuntu 20.04 2.2.7 Secondary Failover Virtualized Debian 11 2.1.5 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfuly.","title":"Tested Configuration"},{"location":"getting-started/validate-configuration/","text":"Validate Configuration \u00b6 Verify Keepalived \u00b6 To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived # on Ubuntu using snap Verify that the Secondary server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived # on Ubuntu using snap Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the secondary goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived # on Ubuntu using snap Verify pihole-FTL failover \u00b6 The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. (This command will not break the pihole-FTL service until we issue a restart command of pihole) echo \"BREAK\" | sudo tee /etc/dnsmasq.d/99-failover-test.conf Restart the pihole process Issue the following command to temporarily bring down the pihole-FTL service. pihole restartdns Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Secondary server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived # on Ubuntu using snap Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the secondary goes into MASTER STATE then keepalived process tracking is working as intended. Remove the previously created file and restart the pihole service to resume DNS functionality. sudo rm /etc/dnsmasq.d/99-failover-test.conf pihole restartdns # [\u2713] Restarting DNS server pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Validate"},{"location":"getting-started/validate-configuration/#validate-configuration","text":"","title":"Validate Configuration"},{"location":"getting-started/validate-configuration/#verify-keepalived","text":"To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived # on Ubuntu using snap Verify that the Secondary server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived # on Ubuntu using snap Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the secondary goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived # on Ubuntu using snap","title":"Verify Keepalived"},{"location":"getting-started/validate-configuration/#verify-pihole-ftl-failover","text":"The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. (This command will not break the pihole-FTL service until we issue a restart command of pihole) echo \"BREAK\" | sudo tee /etc/dnsmasq.d/99-failover-test.conf Restart the pihole process Issue the following command to temporarily bring down the pihole-FTL service. pihole restartdns Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Secondary server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived # on Ubuntu using snap Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the secondary goes into MASTER STATE then keepalived process tracking is working as intended. Remove the previously created file and restart the pihole service to resume DNS functionality. sudo rm /etc/dnsmasq.d/99-failover-test.conf pihole restartdns # [\u2713] Restarting DNS server pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Verify pihole-FTL failover"},{"location":"next-steps/gravity-sync/","text":"Gravity Sync \u00b6 If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"},{"location":"next-steps/gravity-sync/#gravity-sync","text":"If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"}]}