{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Home \u00b6 Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"#home","text":"Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"feedback/","text":"Feedback Welcomed \u00b6 Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"feedback/#feedback-welcomed","text":"Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"getting-started/configure-keepalived/","text":"Configure Keepalived \u00b6 Determine your IP address \u00b6 Run the following command to find your IP address and interface in use on primary and backup servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12/24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Primary eth0 10.0.100.11 Backup ens192 10.0.100.12 VIP * - 10.0.100.10/24 *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10/24 (as shown in the above table). Configuration \u00b6 Use the editor of your choice to open the keepalived configuration on both Primary and Backup servers. You can add as many backup servers using the backup server configuration. sudo nano /etc/keepalived/keepalived.conf Primary Server (Master) \u00b6 Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. mcast_src_ip 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state MASTER interface eth0 virtual_router_id 55 priority 150 advert_int 1 mcast_src_ip 10 .0.100.11 authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 # (2) } track_process { ftl } } auth_pass should match on all servers. virtual_ipaddress should match on all servers. Backup Server(s) \u00b6 Change the values according to the following table for each backup server. Field Current Value Change to interface ens192 Your Backup server's Interface. mcast_src_ip 10.0.100.12 Your Backup server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Priority 145 For each backup server the priority can be decreased effectively setting failover order. Backup Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 55 priority 145 advert_int 1 mcast_src_ip 10 .0.100.12 authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 # (2) } track_process { ftl } } auth_pass should match on all servers. virtual_ipaddress should match on all servers. Restart Keepalived \u00b6 Ubuntu/Raspberry Pi OS \u00b6 (using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived Debian \u00b6 sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Configure"},{"location":"getting-started/configure-keepalived/#configure-keepalived","text":"","title":"Configure Keepalived"},{"location":"getting-started/configure-keepalived/#determine-your-ip-address","text":"Run the following command to find your IP address and interface in use on primary and backup servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12/24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Primary eth0 10.0.100.11 Backup ens192 10.0.100.12 VIP * - 10.0.100.10/24 *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10/24 (as shown in the above table).","title":"Determine your IP address"},{"location":"getting-started/configure-keepalived/#configuration","text":"Use the editor of your choice to open the keepalived configuration on both Primary and Backup servers. You can add as many backup servers using the backup server configuration. sudo nano /etc/keepalived/keepalived.conf","title":"Configuration"},{"location":"getting-started/configure-keepalived/#primary-server-master","text":"Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. mcast_src_ip 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state MASTER interface eth0 virtual_router_id 55 priority 150 advert_int 1 mcast_src_ip 10 .0.100.11 authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 # (2) } track_process { ftl } } auth_pass should match on all servers. virtual_ipaddress should match on all servers.","title":"Primary Server (Master)"},{"location":"getting-started/configure-keepalived/#backup-servers","text":"Change the values according to the following table for each backup server. Field Current Value Change to interface ens192 Your Backup server's Interface. mcast_src_ip 10.0.100.12 Your Backup server's IP. auth_pass xxXxxxXX New 8 character password. (This will be the same in both configurations) virtual_ipaddress 10.0.100.10/24 Your chosen VIP . Priority 145 For each backup server the priority can be decreased effectively setting failover order. Backup Server: /etc/keepalived/keepalived.conf vrrp_track_process ftl { process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 55 priority 145 advert_int 1 mcast_src_ip 10 .0.100.12 authentication { auth_type PASS auth_pass xxXxxxXX # (1) } virtual_ipaddress { 10 .0.100.10/24 # (2) } track_process { ftl } } auth_pass should match on all servers. virtual_ipaddress should match on all servers.","title":"Backup Server(s)"},{"location":"getting-started/configure-keepalived/#restart-keepalived","text":"","title":"Restart Keepalived"},{"location":"getting-started/configure-keepalived/#ubunturaspberry-pi-os","text":"(using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived","title":"Ubuntu/Raspberry Pi OS"},{"location":"getting-started/configure-keepalived/#debian","text":"sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Debian"},{"location":"getting-started/install-keepalived/","text":"Install Keepalived \u00b6 Ubuntu \u00b6 Use snap to install the latest version of keepalived and apt to install libipset13. sudo apt update sudo apt install libipset13 sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/ubuntu for more information Debian \u00b6 sudo apt update sudo apt install keepalived lilbipset13 Raspberry Pi OS \u00b6 Use snap to install the latest version of keepalived and apt to install libipset13. Snapd may not be installed by default. If this is the case, a reboot may be required. * see https://snapcraft.io/install/keepalived/raspbian for more information sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic","title":"Install"},{"location":"getting-started/install-keepalived/#install-keepalived","text":"","title":"Install Keepalived"},{"location":"getting-started/install-keepalived/#ubuntu","text":"Use snap to install the latest version of keepalived and apt to install libipset13. sudo apt update sudo apt install libipset13 sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/ubuntu for more information","title":"Ubuntu"},{"location":"getting-started/install-keepalived/#debian","text":"sudo apt update sudo apt install keepalived lilbipset13","title":"Debian"},{"location":"getting-started/install-keepalived/#raspberry-pi-os","text":"Use snap to install the latest version of keepalived and apt to install libipset13. Snapd may not be installed by default. If this is the case, a reboot may be required. * see https://snapcraft.io/install/keepalived/raspbian for more information sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic","title":"Raspberry Pi OS"},{"location":"getting-started/tested-configuration/","text":"Tested Configuration \u00b6 Server Platform OS Keepalived Version Primary Raspberry Pi Ubuntu 20.04 2.2.7 Backup Virtualized Debian 11 2.1.5 Backup Raspberry Pi Raspberry Pi OS (Bullseye) 2.2.7 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfully.","title":"Tested Configuration"},{"location":"getting-started/tested-configuration/#tested-configuration","text":"Server Platform OS Keepalived Version Primary Raspberry Pi Ubuntu 20.04 2.2.7 Backup Virtualized Debian 11 2.1.5 Backup Raspberry Pi Raspberry Pi OS (Bullseye) 2.2.7 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfully.","title":"Tested Configuration"},{"location":"getting-started/validate-configuration/","text":"Validate Configuration \u00b6 Verify Keepalived \u00b6 To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived Verify that the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived Verify pihole-FTL failover \u00b6 The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. Stop the pihole process Issue the following command to temporarily bring down the pihole-FTL service. sudo systemctl stop pihole-FTL.service Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from backup server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived process tracking is working as intended. Start the pihole process sudo systemctl start pihole-FTL.service pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Validate"},{"location":"getting-started/validate-configuration/#validate-configuration","text":"","title":"Validate Configuration"},{"location":"getting-started/validate-configuration/#verify-keepalived","text":"To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived Verify that the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived","title":"Verify Keepalived"},{"location":"getting-started/validate-configuration/#verify-pihole-ftl-failover","text":"The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. Stop the pihole process Issue the following command to temporarily bring down the pihole-FTL service. sudo systemctl stop pihole-FTL.service Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from backup server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived process tracking is working as intended. Start the pihole process sudo systemctl start pihole-FTL.service pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Verify pihole-FTL failover"},{"location":"next-steps/gravity-sync/","text":"Gravity Sync \u00b6 If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"},{"location":"next-steps/gravity-sync/#gravity-sync","text":"If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"}]}