{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Home \u00b6 Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"#home","text":"Disclaimer This documenation is not affiliated with Pi-hole \u00ae and is not sponsored or sanctioned by the Pi-hole\u00ae team. Please consider this a free community-driven guide and report any issues to the author's Github page . Pi-hole is and the Pi-hole logo are registered trademarks of Pi-hole LLC. Keepalived is a framework for both loadbalancing and high availabilty. It creates a Virtual IP ( VIP ) to route traffic to all participating hosts. Gravity-Sync can additionaly be used to replicate configurations between each server. Get Started","title":"Home"},{"location":"feedback/","text":"Feedback Welcomed \u00b6 Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"feedback/#feedback-welcomed","text":"Comments, Questions, Concerns? Please feel free to open an issue in Github . Want to suggest an alternative or better method? Feel free to fork this repository and create a pull request for the development branch.","title":"Feedback Welcomed"},{"location":"getting-started/configure-keepalived/","text":"Configure Keepalived \u00b6 Create user for keepalived scripts \u00b6 It is necessary to create a new system user for keeplaived to use to run tracking scripts. Otherwise, you can use an existing user or root. Create keepalived_script user sudo useradd -r -s /sbin/nologin -M keepalived_script Create tracking script \u00b6 A simple tracking script can be used to verify DNS resolution. For simplicity the script checks for the existence of TXT record for pdc.ztsplunker.com . This is a custom domain and it is recommended to switch this to a domain of your choosing. Along with this script, the keepalived configuration will track the pihole-FTL process. Save the following script in /etc/keepalived/ . check-dns.sh script #!/bin/bash # # Checks DNS resolution # RESULT = $( dig @localhost +time = 1 +tries = 1 +short pdc.ztsplunker.com txt ) test $? -ne 0 && exit 1 test -z $RESULT && exit 1 exit 0 pdc.ztsplunker.com should be updated to a valid domain with the existence of a TXT record. Set executable permissions for the script. sudo chmod +x /etc/keepalived/check-dns.sh Determine your IP address \u00b6 Run the following command to find your IP address and interface in use on the keepalived servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12 /24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Priority Primary eth0 10.0.100.11 150 Backup ens192 10.0.100.12 145 VIP * - 10.0.100.10 - *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10 (as shown in the above table). Configuration \u00b6 Use the editor of your choice to open the keepalived configuration on each keepalived server. You can add as many servers using the following configuration. sudo nano /etc/keepalived/keepalived.conf Note Each server will be configured as BACKUP allowing the highest priority to be set to the master. Primary Server (Master) \u00b6 Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. Priority 150 (make sure the primary has the highest priority) mcast_src_ip 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password (This will be the same across all servers). virtual_ipaddress 10.0.100.10 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf global_defs { max_auto_priority 10 enable_script_security script_user keepalived_script # (1) } vrrp_track_process ftl { # (4) process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_script check_dns { script /etc/keepalived/check-dns.sh # (5) interval 4 timeout 2 } vrrp_instance PIHOLE { state BACKUP interface eth0 virtual_router_id 100 priority 150 advert_int 1 mcast_src_ip 10.0.100.11 authentication { auth_type PASS auth_pass xxXxxxXX # (2) } virtual_ipaddress { 10.0.100.10 # (3) } track_process { ftl } track_script { check_dns } } keepalived_script user must be created before proceeding (see Create user for keepalived scripts ). auth_pass should match on all servers. virtual_ipaddress should match on all servers. Tracks the existence pihole-FTL process. Confirm existence of tracking script and location (see Create Tracking Script ). Backup Server(s) \u00b6 Change the values according to the following table for each backup server. Field Current Value Change to interface ens192 Your Backup server's Interface. Priority 145 For each backup server the priority can be decreased effectively setting failover order. mcast_src_ip 10.0.100.12 Your Backup server's IP. auth_pass xxXxxxXX New 8 character password (This will be the same across all servers). virtual_ipaddress 10.0.100.10 Your chosen VIP . Backup Server: /etc/keepalived/keepalived.conf global_defs { max_auto_priority 10 enable_script_security script_user keepalived_script # (1) } vrrp_track_process ftl { # (4) process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_script check_dns { script /etc/keepalived/check-dns.sh # (5) interval 4 timeout 2 } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 100 priority 145 advert_int 1 mcast_src_ip 10.0.100.12 authentication { auth_type PASS auth_pass xxXxxxXX # (2) } virtual_ipaddress { 10.0.100.10 # (3) } track_process { ftl } track_script { check_dns } } keepalived_script user must be created before proceeding (see Create user for keepalived scripts ). auth_pass should match on all servers. virtual_ipaddress should match on all servers. Tracks the existence pihole-FTL process. Confirm existence of tracking script and location (see Create Tracking Script ). Restart Keepalived \u00b6 Ubuntu/Raspberry Pi OS \u00b6 (using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived Debian \u00b6 sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Configure"},{"location":"getting-started/configure-keepalived/#configure-keepalived","text":"","title":"Configure Keepalived"},{"location":"getting-started/configure-keepalived/#create-user-for-keepalived-scripts","text":"It is necessary to create a new system user for keeplaived to use to run tracking scripts. Otherwise, you can use an existing user or root. Create keepalived_script user sudo useradd -r -s /sbin/nologin -M keepalived_script","title":"Create user for keepalived scripts"},{"location":"getting-started/configure-keepalived/#create-tracking-script","text":"A simple tracking script can be used to verify DNS resolution. For simplicity the script checks for the existence of TXT record for pdc.ztsplunker.com . This is a custom domain and it is recommended to switch this to a domain of your choosing. Along with this script, the keepalived configuration will track the pihole-FTL process. Save the following script in /etc/keepalived/ . check-dns.sh script #!/bin/bash # # Checks DNS resolution # RESULT = $( dig @localhost +time = 1 +tries = 1 +short pdc.ztsplunker.com txt ) test $? -ne 0 && exit 1 test -z $RESULT && exit 1 exit 0 pdc.ztsplunker.com should be updated to a valid domain with the existence of a TXT record. Set executable permissions for the script. sudo chmod +x /etc/keepalived/check-dns.sh","title":"Create tracking script"},{"location":"getting-started/configure-keepalived/#determine-your-ip-address","text":"Run the following command to find your IP address and interface in use on the keepalived servers. ip -br a Example output lo UNKNOWN 127.0.0.1/8 ::1/128 ens192 UP 10.0.100.12 /24 fe81::21c:24fe:fe2a:4c96/64 The interface, for this example, is ens192 with the ip 10.0.100.12 Example values that will be used. Server Interface IP Priority Primary eth0 10.0.100.11 150 Backup ens192 10.0.100.12 145 VIP * - 10.0.100.10 - *the VIP is any unused IP space in your subnet. This example will use 10.0.100.10 (as shown in the above table).","title":"Determine your IP address"},{"location":"getting-started/configure-keepalived/#configuration","text":"Use the editor of your choice to open the keepalived configuration on each keepalived server. You can add as many servers using the following configuration. sudo nano /etc/keepalived/keepalived.conf Note Each server will be configured as BACKUP allowing the highest priority to be set to the master.","title":"Configuration"},{"location":"getting-started/configure-keepalived/#primary-server-master","text":"Change the values according to the following table. Field Current Value Change to interface eth0 Your Primary server's Interface. Priority 150 (make sure the primary has the highest priority) mcast_src_ip 10.0.100.11 Your Primary server's IP. auth_pass xxXxxxXX New 8 character password (This will be the same across all servers). virtual_ipaddress 10.0.100.10 Your chosen VIP . Primary Server: /etc/keepalived/keepalived.conf global_defs { max_auto_priority 10 enable_script_security script_user keepalived_script # (1) } vrrp_track_process ftl { # (4) process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_script check_dns { script /etc/keepalived/check-dns.sh # (5) interval 4 timeout 2 } vrrp_instance PIHOLE { state BACKUP interface eth0 virtual_router_id 100 priority 150 advert_int 1 mcast_src_ip 10.0.100.11 authentication { auth_type PASS auth_pass xxXxxxXX # (2) } virtual_ipaddress { 10.0.100.10 # (3) } track_process { ftl } track_script { check_dns } } keepalived_script user must be created before proceeding (see Create user for keepalived scripts ). auth_pass should match on all servers. virtual_ipaddress should match on all servers. Tracks the existence pihole-FTL process. Confirm existence of tracking script and location (see Create Tracking Script ).","title":"Primary Server (Master)"},{"location":"getting-started/configure-keepalived/#backup-servers","text":"Change the values according to the following table for each backup server. Field Current Value Change to interface ens192 Your Backup server's Interface. Priority 145 For each backup server the priority can be decreased effectively setting failover order. mcast_src_ip 10.0.100.12 Your Backup server's IP. auth_pass xxXxxxXX New 8 character password (This will be the same across all servers). virtual_ipaddress 10.0.100.10 Your chosen VIP . Backup Server: /etc/keepalived/keepalived.conf global_defs { max_auto_priority 10 enable_script_security script_user keepalived_script # (1) } vrrp_track_process ftl { # (4) process \"/usr/bin/pihole-FTL\" delay 2 quorum 1 full_command true } vrrp_script check_dns { script /etc/keepalived/check-dns.sh # (5) interval 4 timeout 2 } vrrp_instance PIHOLE { state BACKUP interface ens192 virtual_router_id 100 priority 145 advert_int 1 mcast_src_ip 10.0.100.12 authentication { auth_type PASS auth_pass xxXxxxXX # (2) } virtual_ipaddress { 10.0.100.10 # (3) } track_process { ftl } track_script { check_dns } } keepalived_script user must be created before proceeding (see Create user for keepalived scripts ). auth_pass should match on all servers. virtual_ipaddress should match on all servers. Tracks the existence pihole-FTL process. Confirm existence of tracking script and location (see Create Tracking Script ).","title":"Backup Server(s)"},{"location":"getting-started/configure-keepalived/#restart-keepalived","text":"","title":"Restart Keepalived"},{"location":"getting-started/configure-keepalived/#ubunturaspberry-pi-os","text":"(using snap) see Install Keepalived with snap. sudo snap restart keepalived To check the status run the following. sudo snap logs keepalived","title":"Ubuntu/Raspberry Pi OS"},{"location":"getting-started/configure-keepalived/#debian","text":"sudo systemctl restart keepalived.service To check the status run the following. sudo systemctl status keepalived.service","title":"Debian"},{"location":"getting-started/install-keepalived/","text":"Install Keepalived \u00b6 Tip It is recommended to use snap to install and maintain keepalived. Ubuntu \u00b6 Use snap to install the latest version of keepalived and apt to install libipset13. sudo apt update sudo apt install libipset13 sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/ubuntu for more information Debian \u00b6 Install using apt \u00b6 sudo apt update sudo apt install keepalived lilbipset13 -- OR -- Install using snap \u00b6 sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/debian for more information Raspberry Pi OS \u00b6 Use snap to install the latest version of keepalived and apt to install libipset13. Snapd may not be installed by default. If this is the case, a reboot may be required. * see https://snapcraft.io/install/keepalived/raspbian for more information sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic","title":"Install"},{"location":"getting-started/install-keepalived/#install-keepalived","text":"Tip It is recommended to use snap to install and maintain keepalived.","title":"Install Keepalived"},{"location":"getting-started/install-keepalived/#ubuntu","text":"Use snap to install the latest version of keepalived and apt to install libipset13. sudo apt update sudo apt install libipset13 sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/ubuntu for more information","title":"Ubuntu"},{"location":"getting-started/install-keepalived/#debian","text":"","title":"Debian"},{"location":"getting-started/install-keepalived/#install-using-apt","text":"sudo apt update sudo apt install keepalived lilbipset13 -- OR --","title":"Install using apt"},{"location":"getting-started/install-keepalived/#install-using-snap","text":"sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic * see https://snapcraft.io/install/keepalived/debian for more information","title":"Install using snap"},{"location":"getting-started/install-keepalived/#raspberry-pi-os","text":"Use snap to install the latest version of keepalived and apt to install libipset13. Snapd may not be installed by default. If this is the case, a reboot may be required. * see https://snapcraft.io/install/keepalived/raspbian for more information sudo apt update sudo apt install snapd libipset13 sudo reboot sudo snap install core sudo snap install keepalived --classic","title":"Raspberry Pi OS"},{"location":"getting-started/tested-configuration/","text":"Tested Configuration \u00b6 Server Platform OS Keepalived Version Primary Raspberry Pi Ubuntu 20.04 2.2.7 Backup Virtualized Debian 11 2.1.5 Backup Raspberry Pi Raspberry Pi OS (Bullseye) 2.2.7 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfully.","title":"Tested Configuration"},{"location":"getting-started/tested-configuration/#tested-configuration","text":"Server Platform OS Keepalived Version Primary Raspberry Pi Ubuntu 20.04 2.2.7 Backup Virtualized Debian 11 2.1.5 Backup Raspberry Pi Raspberry Pi OS (Bullseye) 2.2.7 Known issue An issue arose when attempting to track the FTL process on an older keepalived version. The above versions have been tested to work successfully.","title":"Tested Configuration"},{"location":"getting-started/validate-configuration/","text":"Validate Configuration \u00b6 Verify Keepalived \u00b6 To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived Verify that the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived Verify pihole-FTL failover \u00b6 The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. Stop the pihole process Issue the following command to temporarily bring down the pihole-FTL service. sudo systemctl stop pihole-FTL.service Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from backup server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived process tracking is working as intended. Start the pihole process sudo systemctl start pihole-FTL.service pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Validate"},{"location":"getting-started/validate-configuration/#validate-configuration","text":"","title":"Validate Configuration"},{"location":"getting-started/validate-configuration/#verify-keepalived","text":"To verify keepalived is working as it should in the Master/backup states, the keepalived process can be temporarily disabled on the Primary server . sudo systemctl stop keepalived.service # - OR - sudo snap stop keepalived Verify that the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from secondary server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived is working as intended. Restart the keepalived service on the Primary server . sudo systemctl start keepalived.service # - OR - sudo snap start keepalived","title":"Verify Keepalived"},{"location":"getting-started/validate-configuration/#verify-pihole-ftl-failover","text":"The keepalived configuration is setup to failover when the pihole-FTL process is no longer running. To test this configuration without restarting your server you can temporarily \"break\" the service. Danger The following will temporarily break DNS resolution for the clients using the primary server. On the Primary server , run the following command. Stop the pihole process Issue the following command to temporarily bring down the pihole-FTL service. sudo systemctl stop pihole-FTL.service Check the status of Pihole to ensure DNS is not working. pihole status # [\u2717] DNS service is NOT running Verify the Backup server has assumed the master state. sudo systemctl status keepalived.service # - OR - sudo snap logs keepalived Example output from backup server Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Backup received priority 0 advertisement Keepalived_vrrp [ 239456 ] : ( PIHOLE ) Entering MASTER STATE If the backup goes into MASTER STATE then keepalived process tracking is working as intended. Start the pihole process sudo systemctl start pihole-FTL.service pihole status # [\u2713] FTL is listening on port 53 # [\u2713] UDP (IPv4) # [\u2713] TCP (IPv4) # [\u2713] UDP (IPv6) # [\u2713] TCP (IPv6) # [\u2713] Pi-hole blocking is enabled","title":"Verify pihole-FTL failover"},{"location":"next-steps/gravity-sync/","text":"Gravity Sync \u00b6 If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"},{"location":"next-steps/gravity-sync/#gravity-sync","text":"If you are looking to replicate configurations between your Pi-hole\u00ae servers, check out Gravity Sync . Gravity Sync is not developed by the Pi-hole\u00ae team but has been proven to work for most use cases. Check out the documentation on the author's Github page !","title":"Gravity Sync"},{"location":"next-steps/integrate-with-splunk/","text":"Integrate with Splunk \u00b6 Track state changes using Splunk HTTP Event Collector ( HEC ). The following will create similar events in Splunk allowing you to more easily track state changes over time. Prerequisites \u00b6 See Splunk Docs on how to configure the HTTP Event Collector on Splunk Enterprise. Save created HEC token for next steps. Create script \u00b6 The VRRP instance can be configured to run a script when there is a state change. The following is an example script to be used with Splunk. Place script in /etc/keepalived . notify-splunk.sh #!/bin/bash # # Send state changes to Splunk # hostname=$(hostname) state=$3 cdate=$(date +%s) data_gen(){ cat <<EOF { \"time\": \"$cdate\", \"host\": \"$hostname\", \"source\": \"${hostname}-keepalived-hec\", \"sourcetype\": \"_json\", \"index\": \"netops\", \"event\": {\"event\": \"state-change\", \"state\": \"$state\"} } EOF } curl -k \"https:// splunk-ip-fqdn:8088 /services/collector/event\" \\ -H \"Authorization: Splunk $SPLUNK_HEC_TOKEN \" \\ -d \"$(data_gen)\" The index field in the above script is hard coded to netops . This may be removed if you want default to the index that was sent upon the creation of the HEC token. Or replace with the desired index. Update the curl command with the correct IP or FQDN. SPLUNK_HEC_TOKEN may be replaced with the actual token value. For better script security, an environment variable can be used. Give the script executable permissions when finished. sudo chmod +x /etc/keepalived/notify-splunk.sh Update keepalived.conf \u00b6 Add notify /etc/keepalived/notify-splunk.sh to the vrrp_instance. keepalived.conf example ... vrrp_instance PIHOLE { state BACKUP interface eth0 virtual_router_id 100 priority 150 advert_int 1 mcast_src_ip 10 .0.10.10 notify /etc/keepalived/notify-splunk.sh ... Restart the keepalived service.","title":"Integrate with Splunk"},{"location":"next-steps/integrate-with-splunk/#integrate-with-splunk","text":"Track state changes using Splunk HTTP Event Collector ( HEC ). The following will create similar events in Splunk allowing you to more easily track state changes over time.","title":"Integrate with Splunk"},{"location":"next-steps/integrate-with-splunk/#prerequisites","text":"See Splunk Docs on how to configure the HTTP Event Collector on Splunk Enterprise. Save created HEC token for next steps.","title":"Prerequisites"},{"location":"next-steps/integrate-with-splunk/#create-script","text":"The VRRP instance can be configured to run a script when there is a state change. The following is an example script to be used with Splunk. Place script in /etc/keepalived . notify-splunk.sh #!/bin/bash # # Send state changes to Splunk # hostname=$(hostname) state=$3 cdate=$(date +%s) data_gen(){ cat <<EOF { \"time\": \"$cdate\", \"host\": \"$hostname\", \"source\": \"${hostname}-keepalived-hec\", \"sourcetype\": \"_json\", \"index\": \"netops\", \"event\": {\"event\": \"state-change\", \"state\": \"$state\"} } EOF } curl -k \"https:// splunk-ip-fqdn:8088 /services/collector/event\" \\ -H \"Authorization: Splunk $SPLUNK_HEC_TOKEN \" \\ -d \"$(data_gen)\" The index field in the above script is hard coded to netops . This may be removed if you want default to the index that was sent upon the creation of the HEC token. Or replace with the desired index. Update the curl command with the correct IP or FQDN. SPLUNK_HEC_TOKEN may be replaced with the actual token value. For better script security, an environment variable can be used. Give the script executable permissions when finished. sudo chmod +x /etc/keepalived/notify-splunk.sh","title":"Create script"},{"location":"next-steps/integrate-with-splunk/#update-keepalivedconf","text":"Add notify /etc/keepalived/notify-splunk.sh to the vrrp_instance. keepalived.conf example ... vrrp_instance PIHOLE { state BACKUP interface eth0 virtual_router_id 100 priority 150 advert_int 1 mcast_src_ip 10 .0.10.10 notify /etc/keepalived/notify-splunk.sh ... Restart the keepalived service.","title":"Update keepalived.conf"}]}